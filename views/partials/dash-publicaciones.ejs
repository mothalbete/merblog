<!-- FILTROS -->
<div class="filtros-vapor">

    <!-- ============================
         FECHAS √öNICAS
    ============================ -->
    <%
        const fechasUnicas = [];

        fechasDisponibles.forEach(f => {
            const fecha = f.fecha_publicacion.toISOString().split('T')[0];
            if (!fechasUnicas.includes(fecha)) {
                fechasUnicas.push(fecha);
            }
        });

        fechasUnicas.sort((a, b) => new Date(b) - new Date(a));
    %>

    <select id="filtro-fecha" class="filtro-select">
        <option value="">Todas las fechas</option>
        <% fechasUnicas.forEach(fecha => { %>
            <option value="<%= fecha %>">
                <%= new Date(fecha).toLocaleDateString("es-ES") %>
            </option>
        <% }) %>
    </select>

    <!-- ============================
         ETIQUETAS √öNICAS
    ============================ -->
    <%
        const etiquetasUnicas = [];

        etiquetasDisponibles.forEach(e => {
            if (!etiquetasUnicas.includes(e.etiqueta)) {
                etiquetasUnicas.push(e.etiqueta);
            }
        });

        etiquetasUnicas.sort();
    %>

    <select id="filtro-etiqueta" class="filtro-select">
        <option value="">Todas las etiquetas</option>
        <% etiquetasUnicas.forEach(et => { %>
            <option value="<%= et %>"><%= et %></option>
        <% }) %>
    </select>

</div>

<!-- GRID -->
<div class="dash-publicaciones-grid" id="grid-publicaciones">

    <% if (publicaciones.length === 0) { %>
        <p class="no-publicaciones-msg">No hay publicaciones todav√≠a.</p>
    <% } %>

    <% publicaciones.forEach(pub => {

        let seguidores = [];
        if (pub.usuarios && pub.usuarios.seguidores) {
            seguidores = pub.usuarios.seguidores;
        }

        const yaSigo = seguidores.some(s => s.id_seguidor === user.id);

        const etiquetasStr = pub.publicacion_etiquetas
            ? pub.publicacion_etiquetas.map(e => e.etiqueta).join(',')
            : "";
    %>

        <div class="pub-card-vapor"
            data-id="<%= pub.id_publicacion %>"
            data-fecha="<%= pub.fecha_publicacion.toISOString().split('T')[0] %>"
            data-etiquetas="<%= etiquetasStr %>">

            <img src="<%= pub.imagen %>" alt="Publicaci√≥n">

            <div class="pub-card-author">

                <!-- NOMBRE DEL AUTOR ‚Üí ABRE PERFIL P√öBLICO -->
                <a class="usuario-link" href="/perfil-publico/<%= pub.id_usuario %>">
                    @<%= pub.usuarios.nombre %>
                </a>

                <span class="pub-visitas">üëÅ <%= pub.numero_visitas %></span>

                <% if (pub.id_usuario !== user.id) { %>

                    <% if (!yaSigo) { %>
                        <button class="btn-seguir-small seguir-btn" data-user="<%= pub.id_usuario %>">
                            Seguir
                        </button>
                    <% } else { %>
                        <button class="btn-siguiendo-small siguiendo-btn" data-user="<%= pub.id_usuario %>">
                            Siguiendo
                        </button>
                    <% } %>

                <% } %>

                <% if (pub.id_usuario === user.id) { %>

                    <button type="button" class="btn-edit-small edit-btn"
                        data-id="<%= pub.id_publicacion %>">
                        Editar
                    </button>

                    <form action="/publicaciones/<%= pub.id_publicacion %>/eliminar"
                        method="POST" class="delete-form"
                        onsubmit="return confirm('¬øSeguro que quieres eliminar esta publicaci√≥n?');">
                        <button type="submit" class="btn-delete-small">Eliminar</button>
                    </form>

                <% } %>

            </div>

        </div>

    <% }) %>

</div>

<script>
    // ============================
    // ABRIR MODAL DE PUBLICACI√ìN
    // ============================
    document.querySelectorAll('.pub-card-vapor').forEach(card => {
        card.addEventListener('click', e => {
            if (e.target.closest('.delete-form')) return;
            if (e.target.classList.contains('seguir-btn')) return;
            if (e.target.classList.contains('siguiendo-btn')) return;
            if (e.target.classList.contains('edit-btn')) return;
            if (e.target.classList.contains('usuario-link')) return;

            cargarPublicacion(card.dataset.id);
            abrirModal();
        });
    });

    // ============================
    // FILTROS
    // ============================
    const filtroFecha = document.getElementById("filtro-fecha");
    const filtroEtiqueta = document.getElementById("filtro-etiqueta");
    const cards = document.querySelectorAll(".pub-card-vapor");

    function aplicarFiltros() {
        const fecha = filtroFecha.value;
        const etiqueta = filtroEtiqueta.value.toLowerCase();

        cards.forEach(card => {
            const cardFecha = card.dataset.fecha;
            const cardEtiquetas = card.dataset.etiquetas.toLowerCase();

            const coincideFecha = !fecha || cardFecha === fecha;
            const coincideEtiqueta = !etiqueta || cardEtiquetas.includes(etiqueta);

            card.style.display = (coincideFecha && coincideEtiqueta) ? "block" : "none";
        });
    }

    filtroFecha.addEventListener("change", aplicarFiltros);
    filtroEtiqueta.addEventListener("change", aplicarFiltros);
</script>
