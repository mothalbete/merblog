<!-- FILTROS -->
<div class="filtros-vapor">

    <!-- FILTRO POR FECHA -->
    <select id="filtro-fecha" class="filtro-select">
        <option value="">Todas las fechas</option>
        <% fechasDisponibles.forEach(f => { %>
            <option value="<%= f.fecha_publicacion.toISOString().split('T')[0] %>">
                <%= f.fecha_publicacion.toLocaleDateString("es-ES") %>
            </option>
        <% }) %>
    </select>

    <!-- FILTRO POR ETIQUETA -->
    <select id="filtro-etiqueta" class="filtro-select">
        <option value="">Todas las etiquetas</option>
        <% etiquetasDisponibles.forEach(e => { %>
            <option value="<%= e.etiqueta %>"><%= e.etiqueta %></option>
        <% }) %>
    </select>

</div>

<!-- GRID DE PUBLICACIONES -->
<div class="dash-publicaciones-grid" id="grid-publicaciones">

    <% if (publicaciones.length === 0) { %>
        <p class="no-publicaciones-msg">No hay publicaciones todavía.</p>
    <% } %>

    <% publicaciones.forEach(pub => { %>
        <div class="pub-card-vapor"
             data-id="<%= pub.id_publicacion %>"
             data-fecha="<%= pub.fecha_publicacion.toISOString().split('T')[0] %>"
             data-etiquetas="<%= pub.publicacion_etiquetas?.map(e => e.etiqueta).join(',') || '' %>">

            <img src="<%= pub.imagen %>" alt="Publicación">

            <div class="pub-card-author">
                @<%= pub.usuarios.nombre %>

                <% if (pub.id_usuario === user.id) { %>

                    <!-- BOTÓN EDITAR -->
                    <button type="button"
                            class="btn-edit-small"
                            onclick="event.stopPropagation(); abrirModalEditar('<%= pub.id_publicacion %>')">
                        Editar
                    </button>

                    <!-- BOTÓN ELIMINAR -->
                    <form action="/publicaciones/<%= pub.id_publicacion %>/eliminar" 
                          method="POST" 
                          class="delete-form"
                          onclick="event.stopPropagation();"
                          onsubmit="return confirm('¿Seguro que quieres eliminar esta publicación?');">
                        <button type="submit" class="btn-delete-small">Eliminar</button>
                    </form>

                <% } %>
            </div>

        </div>
    <% }) %>

</div>

<script>
    // Abrir modal de lectura al hacer clic en la tarjeta (pero no en los botones)
    document.querySelectorAll('.pub-card-vapor').forEach(card => {
        card.addEventListener('click', (e) => {
            if (e.target.closest('.delete-form')) return;

            const id = card.dataset.id;
            cargarPublicacion(id);
            abrirModal();
        });
    });

    // FILTROS
    const filtroFecha = document.getElementById("filtro-fecha");
    const filtroEtiqueta = document.getElementById("filtro-etiqueta");
    const cards = document.querySelectorAll(".pub-card-vapor");

    function aplicarFiltros() {
        const fecha = filtroFecha.value;
        const etiqueta = filtroEtiqueta.value.toLowerCase();

        cards.forEach(card => {
            const cardFecha = card.dataset.fecha;
            const cardEtiquetas = card.dataset.etiquetas.toLowerCase();

            const coincideFecha = !fecha || cardFecha === fecha;
            const coincideEtiqueta = !etiqueta || cardEtiquetas.includes(etiqueta);

            card.style.display = (coincideFecha && coincideEtiqueta) ? "block" : "none";
        });
    }

    filtroFecha.addEventListener("change", aplicarFiltros);
    filtroEtiqueta.addEventListener("change", aplicarFiltros);
</script>
