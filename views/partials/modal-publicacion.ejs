<!-- OVERLAY -->
<div id="modal-bg" class="modal-pub-overlay">

    <!-- CONTENEDOR PRINCIPAL -->
    <div id="modal-publicacion" class="modal-pub-card vapor-card">

        <!-- BOTÓN CERRAR -->
        <div class="modal-pub-close" onclick="cerrarModal()">✖</div>

        <!-- COLUMNA IZQUIERDA -->
        <div class="modal-pub-left">

            <img id="modal-img" src="" alt="Imagen" class="modal-pub-img">

            <!-- ACCIONES (EDITAR / ELIMINAR) -->
            <div id="modal-actions" style="padding: 10px; text-align:center;"></div>

            <!-- ACORDEÓN -->
            <div class="modal-acordeon" onclick="toggleAcordeon()">
                Información de la publicación ⯆
            </div>

            <div id="acordeon-contenido" class="modal-acordeon-content">
                <h2 id="modal-titulo" class="modal-pub-title"></h2>

                <p id="modal-contenido-texto" class="modal-pub-text"></p>

                <p class="modal-pub-meta">
                    <strong>Autor:</strong> @<span id="modal-autor"></span>
                </p>

                <p class="modal-pub-meta">
                    <strong>Fecha:</strong> <span id="modal-fecha"></span>
                </p>

                <div class="modal-pub-tags">
                    <strong>Etiquetas:</strong>
                    <span id="modal-etiquetas"></span>
                </div>
            </div>
        </div>

        <!-- COLUMNA DERECHA -->
        <div class="modal-pub-right">

            <h3 class="modal-pub-subtitle">Comentarios</h3>

            <div class="modal-pub-comments" id="modal-comentarios"></div>

            <!-- FORMULARIO -->
            <form id="modal-form" method="POST" class="modal-pub-form vapor-form">
                <textarea name="texto" required class="modal-pub-textarea"></textarea>

                <button type="submit" class="btn btn-primary">Enviar</button>
            </form>

        </div>
    </div>
</div>

<script>
    function abrirModal() {
        document.getElementById("modal-bg").style.display = "flex";
    }

    function cerrarModal() {
        document.getElementById("modal-bg").style.display = "none";
    }

    // Cerrar modal haciendo clic fuera
    window.addEventListener("click", function (e) {
        const fondo = document.getElementById("modal-bg");
        if (e.target === fondo) cerrarModal();
    });

    // ACORDEÓN
    function toggleAcordeon() {
        const cont = document.getElementById("acordeon-contenido");
        cont.classList.toggle("abierto");
    }

    // Cargar datos de la publicación
    async function cargarPublicacion(id) {
        const res = await fetch(`/publicaciones/${id}`);
        const data = await res.json();

        document.getElementById("modal-img").src = data.imagen;
        document.getElementById("modal-titulo").textContent = data.titulo;
        document.getElementById("modal-contenido-texto").textContent = data.contenido;
        document.getElementById("modal-autor").textContent = data.autor;
        document.getElementById("modal-fecha").textContent = new Date(data.fecha).toLocaleString();

        document.getElementById("modal-etiquetas").innerHTML =
            data.etiquetas.map(e => `<span class="tag">#${e}</span>`).join("");

        // COMENTARIOS
        const contComentarios = document.getElementById("modal-comentarios");
        contComentarios.innerHTML =
            data.comentarios.length === 0
                ? "<p class='no-comments'>No hay comentarios.</p>"
                : data.comentarios.map(c => `
                    <div class="modal-comment">
                        <strong>@${c.autor}</strong><br>
                        ${c.texto}
                    </div>
                `).join("");

        // FORMULARIO DE COMENTARIOS
        document.getElementById("modal-form").action = `/comentarios/${id}`;

        // ACCIONES (EDITAR / ELIMINAR)
        const actions = document.getElementById("modal-actions");

        if (data.propietario) {
            actions.innerHTML = `
                <button class="btn-edit-small"
                        onclick="abrirModalEditar('${data.id}')">
                    Editar
                </button>

                <form action="/publicaciones/${data.id}/eliminar"
                      method="POST"
                      onsubmit="return confirm('¿Seguro que quieres eliminar esta publicación?');"
                      style="display:inline-block;">
                    <button type="submit" class="btn-delete-small">Eliminar</button>
                </form>
            `;
        } else {
            actions.innerHTML = "";
        }
    }
</script>
